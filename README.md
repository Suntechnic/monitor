# Управление яркостью сеттинга из нескольских моинторов
(README написан Copilotom)

Скрипт `br.php` подбирает яркость ведомых мониторов так, чтобы их кажущаяся светимость приблизительно совпадала со светимостью главного монитора. Работает в двух режимах:

- ручной: вы задаёте яркость главного монитора (0–100), скрипт рассчитывает и выставляет яркость для остальных;
- автоматический: по текущей освещённости в комнате (с веб‑камеры) подбирает яркость главного и остальных мониторов.


## Как это работает

1. Для каждого монитора используется своя калибровочная карта «яркость (0–100) → светимость (Lux)». Эти карты задаются в `monitors.php`.
2. Для заданной яркости главного монитора вычисляется его светимость (интерполяцией по карте главного), затем для каждого ведомого находится такая яркость, при которой их светимость совпадает с главной (интерполяция по обратной карте ведомого).
3. Выставление яркости выполняется вспомогательным скриптом `brightness` через `ddccontrol`.
4. В автоматическом режиме текущая освещённость берётся скриптом `lux` с веб‑камеры (v4l2-ctl + ffmpeg + ImageMagick). На основе накопленного лога `br.log` строится карта «освещённость → яркость» для автонастройки.


## Состав и зависимости

Файлы:

- `br.php` — основной PHP‑скрипт;
- `brightness` — оболочка над `ddccontrol` для чтения/установки яркости монитора;
- `lux` — получение нормированной освещённости (0..1) с веб‑камеры;
- `monitors.php` — конфигурация мониторов и их калибровочные таблицы;
- `br.log` — лог наблюдений `[дата],яркость,освещённость` (создаётся автоматически).

Зависимости:

- PHP 8.x (CLI);
- ddccontrol;
- v4l2-ctl (из v4l-utils);
- ffmpeg;
- ImageMagick (утилита `convert`).


## Установка и подготовка

1. Убедитесь, что все зависимости установлены в системе.
2. Сделайте скрипты исполняемыми:

```bash
chmod +x ./br.php ./brightness ./lux
```

3. Создайте `monitors.php` с описанием мониторов и калибровочных карт.


## Конфигурация `monitors.php`

Файл должен возвращать массив с описанием мониторов. Первый элемент — главный монитор. Каждый элемент содержит:

- `dev` — путь устройства DDC (например, `dev:/dev/i2c-6`),
- `brightness2lux` — ассоциативный массив «яркость (int 0–100) → светимость (int/float)».

Пример:

```php
<?php
return [
	[
		'dev' => 'dev:/dev/i2c-6', // Главный (G)
		'brightness2lux' => [
			0=>55, 20=>78, 40=>97, 50=>116, 70=>171, 80=>196, 90=>230, 100=>253,
		],
	],
	[
		'dev' => 'dev:/dev/i2c-5', // Левый (L)
		'brightness2lux' => [
			0=>15, 20=>51, 40=>88, 50=>102, 70=>138, 80=>152, 90=>169, 100=>185,
		],
	],
	[
		'dev' => 'dev:/dev/i2c-3', // Правый (R)
		'brightness2lux' => [
			0=>17, 20=>56, 40=>96, 50=>115, 70=>151, 80=>169, 90=>188, 100=>205,
		],
	],
];
```

Советы по калибровке:

- Соберите несколько точек для каждой из яркостей (0, 20, 40, 50, 70, 80, 90, 100).
- Значения светимости должны возрастать с яркостью; при «заломах» скрипт в авто‑режиме сглаживает карту до монотонной (см. ниже).


## Использование

Запускать из каталога со скриптами (или указывать полный путь).

### Ручной режим (задаём яркость главного)

```bash
./br.php 80
```

Скрипт выставит яркость главного = 80, посчитает и применит яркость для остальных.

### Автоматический режим (по освещённости)

```bash
./br.php
```

Скрипт измерит текущую освещённость `lux` и на основе истории `br.log` подберёт яркость. Если данных мало, сначала поработайте в ручном режиме — лог накопится.


## Логирование и ротация

При запуске с явной яркостью в `br.log` добавляется строка вида:

```
[YYYY-MM-DD HH:MM:SS],<brightness>,<lux>
```

Чтобы файл не разрастался, после записи применяется функция `trim_log()` — она ограничивает файл последними 1000 строками, удаляя самые старые. Обрезка атомарна (через временный файл и `rename`).


## Алгоритм (интерполяция и авто‑режим)

- Для преобразования «яркость → светимость» и обратно используется линейная интерполяция между ближайшими известными узлами.
- В авто‑режиме лог `br.log` преобразуется в карту «освещённость → яркость». Значения освещённости масштабируются и сглаживаются до монотонной функции (неубывающей) простым процессом устранения «обратных» участков.
- Итоговая карта используется для вычисления целевой яркости по текущей освещённости.


## Частые проблемы и проверка

- `ddccontrol` не меняет яркость: проверьте права доступа к соответствующему `i2c` устройству (`/dev/i2c-*`) и что монитор поддерживает DDC/CI.
- Путь `dev:/dev/i2c-X` неверен: уточните шину для каждого монитора (`ddccontrol -p`).
- Нет картинки с камеры / нет `convert`: установите `v4l2-ctl`, `ffmpeg`, `ImageMagick`.
- В логе «странные» значения: удалите/переименуйте `br.log` и наберите заново несколько измерений вручную.


## Примечания

- `br.php` — CLI‑скрипт с shebang `#!/usr/bin/env php`; можно вызывать как `php ./br.php 80` или `./br.php 80`.
- Вспомогательные скрипты `brightness` и `lux` — bash‑скрипты; путь к устройствам (`/dev/i2c-*` и `/dev/video*`) при необходимости подправьте под свою систему.
- Значение яркости ограничивается логикой самих мониторов (0..100); при интерполяции результаты округляются до целых.

